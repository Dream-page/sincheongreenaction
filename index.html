<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ë¸Œë¼ìš°ì € ìºì‹œ ë°©ì§€ ë©”íƒ€ íƒœê·¸ (ê°•ë ¥í•¨) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- [í™•ì¸ìš©] ì œëª©ì— (ìµœì¢…) í‘œì‹œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. ì‹¤ì œ ì‚¬ì´íŠ¸ ì œëª©ì´ ì´ë ‡ê²Œ ë°”ë€ŒëŠ”ì§€ í™•ì¸í•´ë³´ì„¸ìš”! -->
    <title>Green Action ì±Œë¦°ì§€ (ìµœì¢…)</title>
    
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN (í˜„í™©íŒ ê·¸ë˜í”„ìš©) --><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Inter í°íŠ¸ ì ìš© (Tailwind ê¸°ë³¸) */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* í˜ì´ì§€ ì „í™˜ ì‹œ ë¶€ë“œëŸ¬ìš´ íš¨ê³¼ */
        .page {
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¹€ */
            animation: fadeIn 0.5s;
        }
        .page.active {
            display: block; /* í™œì„±í™”ëœ í˜ì´ì§€ë§Œ í‘œì‹œ */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        /* ê°¤ëŸ¬ë¦¬ ì¹´ë“œ ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
        .gallery-card img {
            aspect-ratio: 4 / 3;
            object-fit: cover;
        }
        /* [ìˆ˜ì •!] ìƒí’ˆ ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€ */
        /* ì´ ìŠ¤íƒ€ì¼ì€ Tailwind í´ë˜ìŠ¤ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤. */
    </style>
</head>
<body class="bg-gray-50">

    <!-- 1. í—¤ë” ë° ë„¤ë¹„ê²Œì´ì…˜ --><header class="bg-white shadow-md sticky top-0 z-10">
        <nav class="container mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-2">
            <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-emerald-600">ğŸŒ Green Action ì±Œë¦°ì§€</h1>
            <div class="flex gap-2">
                <button data-page="home" class="nav-btn px-2 py-2 sm:px-3 rounded-md text-sm md:text-base font-medium text-white bg-emerald-500 ring-2 ring-emerald-600 shadow-sm">í™ˆ</button>
                <button data-page="gallery" class="nav-btn px-2 py-2 sm:px-3 rounded-md text-sm md:text-base font-medium text-emerald-700 bg-white hover:bg-gray-100">ê°¤ëŸ¬ë¦¬</button>
                <button data-page="dashboard" class="nav-btn px-2 py-2 sm:px-3 rounded-md text-sm md:text-base font-medium text-emerald-700 bg-white hover:bg-gray-100">í˜„í™©íŒ</button>
            </div>
        </nav>
    </header>

    <!-- 2. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ --><main class="container mx-auto p-4 md:p-6">

        <!-- í˜ì´ì§€ 1: í™ˆ (ìº í˜ì¸ ì†Œê°œ) --><section id="home-page" class="page active">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">"ì‹ ì²œì´ˆ Green Action ì±Œë¦°ì§€"ì— ì°¸ì—¬í•˜ì„¸ìš”!</h2>
                <p class="text-gray-600 mb-4">
                    ì§€êµ¬ë¥¼ ì§€í‚¤ëŠ” ì‘ì€ ì‹¤ì²œ! ìš°ë¦¬ ëª¨ë‘ í•¨ê»˜í•´ìš”.
                    ë‹¤ì–‘í•œ ë¯¸ì…˜ì— ì°¸ì—¬í•˜ê³  ì¸ì¦ìƒ·ì„ ì˜¬ë¦¬ë©´ ë©‹ì§„ 'ì œë¡œ ì›¨ì´ìŠ¤íŠ¸' ì„ ë¬¼ì„ ë“œë¦½ë‹ˆë‹¤!
                </p>
                
                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-3">ğŸŒ¿ 4ê°€ì§€ ë¯¸ì…˜</h3>
                    <ul class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <li class="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                            <strong class="font-bold text-emerald-800">ë¯¸ì…˜ 1: ì¤ê¹…/í”Œë¡œê¹… (ë°–ì—ì„œ)</strong>
                            <p class="text-sm text-gray-600">ê°€ì¡±, ì¹œêµ¬ì™€ ë™ë„¤ë¥¼ ì‚°ì±…í•˜ë©° ì“°ë ˆê¸°ë¥¼ ì£¼ì›Œìš”.</p>
                        </li>
                        <li class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                            <strong class="font-bold text-teal-800">ë¯¸ì…˜ 2: ì”ë°˜ ì œë¡œ (ì§‘ì—ì„œ)</strong>
                            <p class="text-sm text-gray-600">ìŒì‹ì„ ë‚¨ê¸°ì§€ ì•Šê³  ë‹¤ ë¨¹ì€ ë¹ˆ ê·¸ë¦‡ì„ ì¸ì¦í•´ìš”.</p>
                        </li>
                        <li class="bg-lime-50 p-4 rounded-lg border border-lime-200">
                            <strong class="font-bold text-lime-800">ë¯¸ì…˜ 3: ë¶„ë¦¬ìˆ˜ê±° ë§ˆìŠ¤í„° (ì§‘ì—ì„œ)</strong>
                            <p class="text-sm text-gray-600">ë¼ë²¨ì„ ë—€ í˜íŠ¸ë³‘, ê¹¨ë—ì´ ì”»ì€ ìº”/í”Œë¼ìŠ¤í‹±ì„ ë¶„ë¦¬ìˆ˜ê±°í•´ìš”.</p>
                        </li>
                        <li class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <strong class="font-bold text-yellow-800">ë¯¸ì…˜ 4: ì—…ì‚¬ì´í´ë§ (ì°½ì˜ í™œë™)</strong>
                            <p class="text-sm text-gray-600">ë²„ë ¤ì§€ëŠ” ë¬¼ê±´ìœ¼ë¡œ ë‚˜ë§Œì˜ ë©‹ì§„ ì‘í’ˆì„ ë§Œë“¤ì–´ìš”.</p>
                        </li>
                    </ul>
                </div>

                <div class="mb-6">
                    <h3 class="text-xl font-semibold text-emerald-700 mb-3">ğŸ ì°¸ì—¬ ìƒí’ˆ</h3>
                    <p class="text-gray-600 mb-4">
                        ì œë¡œì›¨ì´ìŠ¤íŠ¸ í‚¤íŠ¸ (ì°¸ì—¬ ì¸ì› ëª¨ë‘ ì¦ì •!)
                    </p>
                    
                    <!-- [ìˆ˜ì •!] ìƒí’ˆ ì‚¬ì§„ì„ í•˜ë‚˜ë¡œ ì¤„ì´ê³  ê°€ìš´ë° ì •ë ¬ -->
                    <div class="flex justify-center mb-6">
                        <!-- [ìˆ˜ì •ì™„ë£Œ!] ìƒˆë¡œìš´ íŒŒì¼ ID (1_ibb2tH...)ê°€ ì ìš©ëœ ì¸ë„¤ì¼ ì£¼ì†Œì…ë‹ˆë‹¤! -->
                        <img src="https://drive.google.com/thumbnail?id=1_ibb2tH7-Gwb2GtRcmsmKSPXULjYSTFl" alt="ì¹œí™˜ê²½ ì„¤ê±°ì§€ í‚¤íŠ¸" class="w-3/4 sm:w-1/2 rounded-lg shadow object-contain product-image">
                    </div>
                </div>

                <!-- [ìˆ˜ì •!] 'ì¸ì¦ìƒ· ì˜¬ë¦¬ê¸°' ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆì„ <br> íƒœê·¸ë¡œ ëª…í™•íˆ ì§€ì • --><a href="https://forms.gle/Sx47vjpcJqQQZ9yM6" target="_blank" class="block w-full text-center bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-lg py-3 px-6 rounded-lg shadow-md transition duration-300 whitespace-normal leading-tight">
                    ì§€ê¸ˆ ë°”ë¡œ ì±Œë¦°ì§€ ì°¸ì—¬í•˜ê¸°!<br>(ì¸ì¦ìƒ· ì˜¬ë¦¬ê¸°)
                </a>
            </div>
        </section>

        <!-- í˜ì´ì§€ 2: ì¸ì¦ìƒ· ê°¤ëŸ¬ë¦¬ (ì‚¬ìš©ì ìš”ì²­) --><section id="gallery-page" class="page">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ìš°ë¦¬ì˜ ê·¸ë¦° ì•¡ì…˜ ê°¤ëŸ¬ë¦¬</h2>
            <p class="text-gray-600 mb-4">ì¹œêµ¬ë“¤ì˜ ë©‹ì§„ í™˜ê²½ ë³´í˜¸ í™œë™ì„ êµ¬ê²½í•´ ë³´ì„¸ìš”!</p>
            
            <!-- ë¡œë”© ìŠ¤í”¼ë„ˆ --><div id="gallery-loading" class="text-center py-10">
                <p class="text-lg text-gray-600">ê°¤ëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <div id="gallery-grid-container">
                <!-- 
                    ìë°”ìŠ¤í¬ë¦½íŠ¸(loadGallery í•¨ìˆ˜)ì— ì˜í•´
                    ì´ê³³ì— ê°¤ëŸ¬ë¦¬ ì¹´ë“œê°€ í•™ë…„ë³„ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤.
                --></div>
        </section>

        <!-- í˜ì´ì§€ 3: ì‹¤ì‹œê°„ ì°¸ì—¬ í˜„í™©íŒ --><section id="dashboard-page" class="page">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ì‹¤ì‹œê°„ ì°¸ì—¬ í˜„í™©íŒ</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ì´ ì°¸ì—¬ í˜„í™© --><div class="bg-white p-6 rounded-lg shadow-lg text-center">
                    <h3 class="text-lg font-semibold text-gray-500 mb-2">ì´ ì°¸ì—¬ ì¸ì›</h3>
                    <p class="text-5xl font-bold text-emerald-600">
                        <span id="total-participants">...</span>ëª…
                    </p>
                    <p class="text-gray-600 mt-2">
                        (ì „êµìƒ 162ëª… ì¤‘ / ëª©í‘œ 140ëª…)
                    </p>
                </div>

                <!-- í•™ë…„ë³„ ì°¸ì—¬ í˜„í™© (í…ìŠ¤íŠ¸) --><div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">í•™ë…„ë³„ ì°¸ì—¬ í˜„í™©</h3>
                    <ul id="grade-stats-list" class="space-y-3">
                        <li class="flex justify-between items-center"><span class="text-gray-600">1í•™ë…„ (ì´ 25ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                        <li class="flex justify-between items-center"><span class="text-gray-600">2í•™ë…„ (ì´ 20ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                        <li class="flex justify-between items-center"><span class="text-gray-600">3í•™ë…„ (ì´ 40ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                        <li class="flex justify-between items-center"><span class="text-gray-600">4í•™ë…„ (ì´ 28ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                        <li class="flex justify-between items-center"><span class="text-gray-600">5í•™ë…„ (ì´ 20ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                        <li class="flex justify-between items-center"><span class="text-gray-600">6í•™ë…„ (ì´ 38ëª…)</span> <span class="font-bold text-lg text-emerald-600">...ëª…</span></li>
                    </ul>
                </div>
            </div>

            <!-- í•™ë…„ë³„ ì°¸ì—¬ìœ¨ ê·¸ë˜í”„ --><div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                <h3 class="text-xl font-bold text-gray-700 mb-4">í•™ë…„ë³„ ì°¸ì—¬ìœ¨ (ë§‰ëŒ€ ê·¸ë˜í”„)</h3>
                <div class="relative h-64 md:h-80">
                    <canvas id="grade-chart"></canvas>
                </div>
            </div>
        </section>

    </main>
    
    <!-- [ì¶”ê°€] ë²„ì „ í™•ì¸ìš© í‘¸í„° (ë‚˜ì¤‘ì— ì‚­ì œ ê°€ëŠ¥) -->
    <footer class="text-center py-4 text-gray-400 text-xs">
        v.Final - ì‚¬ì§„ 1ê°œ ì ìš© ì™„ë£Œ
    </footer>

    <script>
        // --- [ì„¤ì •] ---
        
        // 1. [í•„ìˆ˜] Google Apps Script(GAS) ì›¹ ì•± URL
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxupn6GwJCShZpRTAKHUhmD2NfYtPzMHJRqE_eBzRpkyfmiCKUZtalMzNFgwwGcX_QWDg/exec";
        
        
        // í•™ë…„ë³„ ì´ í•™ìƒ ìˆ˜ (ê¸°íšì•ˆ ê¸°ì¤€)
        const gradeTotals = {
            "1": 25,
            "2": 20,
            "3": 40,
            "4": 28,
            "5": 20,
            "6": 38
        };

        // --- ë°ì´í„° ì²˜ë¦¬ ë° ë Œë”ë§ ---
        
        // ë°ì´í„°ë¥¼ í•œ ë²ˆë§Œ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ìºì‹œ
        let allEntriesCache = null;

        // 1. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹¤ì œë¡œëŠ” GAS_URL ì‚¬ìš©)
        async function fetchData() {
            try {
                 if (!GAS_URL || GAS_URL.includes("ì—¬ê¸°ì—_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”")) {
                    alert("HTML íŒŒì¼ì˜ GAS_URL ë³€ìˆ˜ì— Apps Script ì›¹ ì•± URLì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return []; // ë¹ˆ ë°°ì—´ ë°˜í™˜
                 }
                // [ìˆ˜ì •!] ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•´ URLì— í˜„ì¬ ì‹œê°„ì„ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
                const response = await fetch(GAS_URL + "?v=" + new Date().getTime());
                if (!response.ok) {
                    // [ì¶”ê°€!] 404 ì˜¤ë¥˜ ì‹œ ë” êµ¬ì²´ì ì¸ ì•ˆë‚´ ì œê³µ
                    if (response.status === 404) {
                         alert(`[ì˜¤ë¥˜ 404] GAS_URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n"${GAS_URL}"\n\n[í•´ê²°ì±…]\n1. Google Apps Scriptì—ì„œ 'ë°°í¬ ê´€ë¦¬'ë¡œ ì´ë™í•˜ì„¸ìš”.\n2. 'í™œì„±' ë°°í¬ì˜ 'ì›¹ ì•± URL'ì„ ë‹¤ì‹œ ë³µì‚¬í•˜ì„¸ìš”.\n3. HTML íŒŒì¼ì˜ GAS_URL ë³€ìˆ˜ì— 'ì •í™•íˆ' ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.`);
                         throw new Error(`HTTP error! status: ${response.status} (Not Found)`);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.error) {
                    console.error("GAS ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", data.error);
                    alert(`[ì˜¤ë¥˜] Google Apps Scriptì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n\n"${data.error}"\n\n[í•´ê²°ì±…]\n1. Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì˜ 'íƒ­ ì´ë¦„'ì„ í™•ì¸í•˜ì„¸ìš”.\n2. Apps Script(Code.gs) íŒŒì¼ì˜ 'SHEET_NAME' ì„¤ì •ì„ ì‹¤ì œ íƒ­ ì´ë¦„ê³¼ 'ë˜‘ê°™ì´' ìˆ˜ì •í•˜ì„¸ìš”.\n3. ìˆ˜ì •í•œ ë’¤ 'ìƒˆ ë²„ì „'ìœ¼ë¡œ ë‹¤ì‹œ ë°°í¬í•˜ì„¸ìš”.`);
                    throw new Error(data.error);
                }

                if (!data.entries) {
                    console.error("GASì—ì„œ ë°˜í™˜ëœ ë°ì´í„° í˜•ì‹ì´ ë‹¤ë¦…ë‹ˆë‹¤. (data.entriesê°€ ì—†ìŒ)", data);
                    throw new Error("GAS ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (data.entries ì—†ìŒ)");
                }
                return data.entries;
            } catch (error) {
                console.error("fetchData ì˜¤ë¥˜:", error);
                if (error.message.includes("ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤") || error.message.includes("404")) {
                    // ìœ„ì—ì„œ ì´ë¯¸ êµ¬ì²´ì ì¸ alertì„ ë„ì› ìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì¶”ê°€ alertì„ ë§‰ìŠµë‹ˆë‹¤.
                } else {
                    alert(`ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n\D${error.message}\n\nF12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•´ë³´ì„¸ìš”.`);
                }
                return []; 
            }
        }

        // 2. ê°¤ëŸ¬ë¦¬ í˜ì´ì§€ ë Œë”ë§
        async function loadGallery() {
            const container = document.getElementById('gallery-grid-container');
            const loading = document.getElementById('gallery-loading');
            
            container.innerHTML = ''; // ê¸°ì¡´ ê°¤ëŸ¬ë¦¬ ë¹„ìš°ê¸°
            loading.style.display = 'block'; // ë¡œë”© í‘œì‹œ

            allEntriesCache = null; 
            const entries = await fetchDataWithCache(); 

            // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ)
            const sortedEntries = entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            loading.style.display = 'none'; // ë¡œë”© ìˆ¨ê¸°ê¸°

            if (sortedEntries.length === 0) {
                container.innerHTML = '<p class="text-gray-600 col-span-full text-center">ì•„ì§ ì œì¶œëœ ì¸ì¦ìƒ·ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ë¡œ ì°¸ì—¬í•´ë³´ì„¸ìš”!</p>';
                return;
            }

            // 1í•™ë…„ë¶€í„° 6í•™ë…„ê¹Œì§€ ìˆœíšŒ
            for (let grade = 1; grade <= 6; grade++) {
                // í˜„ì¬ í•™ë…„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„° í•„í„°ë§
                const gradeEntries = sortedEntries.filter(entry => String(entry.grade) === String(grade));

                // í•™ë…„ë³„ ì„¹ì…˜ ìƒì„±
                const gradeSection = document.createElement('div');
                gradeSection.className = 'mb-12'; // ì„¹ì…˜ ê°„ ë§ˆì§„
                
                // í•™ë…„ë³„ ì œëª© (ì°¸ì—¬ ì¸ì› ìˆ˜ í‘œì‹œ)
                const title = document.createElement('h2');
                title.className = "text-2xl font-bold text-gray-800 mb-4 mt-8 border-b-2 border-emerald-500 pb-2";
                title.textContent = `${grade}í•™ë…„ (${gradeEntries.length}ëª…)`;
                gradeSection.appendChild(title);

                // í•™ë…„ë³„ ê·¸ë¦¬ë“œ ìƒì„±
                const grid = document.createElement('div');
                grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4";

                if (gradeEntries.length === 0) {
                    // í•´ë‹¹ í•™ë…„ ì°¸ì—¬ìê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                    grid.innerHTML = '<p class="text-gray-500 col-span-full">ì•„ì§ ì°¸ì—¬í•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    // ì°¸ì—¬ìê°€ ìˆìœ¼ë©´ ê°¤ëŸ¬ë¦¬ ì¹´ë“œ ìƒì„±
                    gradeEntries.forEach(entry => {
                        const imageUrl = entry.imageUrl || 'https://placehold.co/400x300/e2e8f0/94a3b8?text=?';
                        const anonymizedName = anonymizeName(entry.name);
                        const mission = entry.mission || 'ë¯¸ì…˜ ë¯¸ì§€ì •';
                        const comment = entry.comment || 'ì†Œê°ì´ ì—†ìŠµë‹ˆë‹¤.';
                        const studentClass = entry.class || '?';

                        const card = document.createElement('div');
                        card.className = 'gallery-card bg-white rounded-lg shadow-lg overflow-hidden transition-transform hover:scale-105';
                        card.innerHTML = `
                            <img src="${imageUrl}" alt="${mission} ì¸ì¦ìƒ·" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/400x300/e2e8f0/94a3b8?text=Load%20Error'; this.onerror=null;">
                            <div class="p-4">
                                <span class="inline-block bg-emerald-100 text-emerald-800 text-xs font-semibold px-2.5 py-0.5 rounded-full mb-2">${mission}</span>
                                <h3 class="font-bold text-gray-800">${grade}í•™ë…„ ${studentClass}ë°˜ ${anonymizedName}</h3>
                                <p class="text-sm text-gray-600 mt-1 break-words" title="${comment}">"${comment}"</p>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }
                
                gradeSection.appendChild(grid); // í•™ë…„ ì„¹ì…˜ì— ê·¸ë¦¬ë“œ ì¶”ê°€
                container.appendChild(gradeSection); // ì „ì²´ ì»¨í…Œì´ë„ˆì— í•™ë…„ ì„¹ì…˜ ì¶”ê°€
            }
        }

        // 3. í˜„í™©íŒ í˜ì´ì§€ ë Œë”ë§
        async function loadDashboard(chartInstance) {
            const listElement = document.getElementById('grade-stats-list');
            const totalElement = document.getElementById('total-participants');
            
            listElement.innerHTML = '<li class="text-gray-600 text-center">ë°ì´í„° ë¡œë”© ì¤‘...</li>'; // ë¡œë”© í‘œì‹œ
            totalElement.textContent = '...';
            
            allEntriesCache = null; 
            const data = await fetchDataWithCache(); 

            // --- í˜„í™© ê³„ì‚° ---
            const uniqueParticipants = new Set();
            data.forEach(entry => {
                const identifier = `${entry.grade}-${entry.class}-${entry.name}`;
                if (entry.grade && entry.class && entry.name) { 
                    uniqueParticipants.add(identifier);
                }
            });
            const totalCount = uniqueParticipants.size;
            totalElement.textContent = totalCount;

            const gradeCounts = {};
            uniqueParticipants.forEach(identifier => {
                const grade = identifier.split('-')[0]; // '1', '2', ...
                if (grade) {
                    gradeCounts[grade] = (gradeCounts[grade] || 0) + 1;
                }
            });

            // --- UI ì—…ë°ì´íŠ¸ ---
            listElement.innerHTML = ''; // ë¦¬ìŠ¤íŠ¸ ë¹„ìš°ê¸°
            const chartLabels = [];
            const chartData = [];

            for (const grade in gradeTotals) {
                const total = gradeTotals[grade]; // í•™ë…„ ì´ì›
                const count = gradeCounts[grade] || 0; // í•™ë…„ ì°¸ì—¬ ì¸ì›
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;

                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1';
                li.innerHTML = `
                    <span class="text-gray-600">${grade}í•™ë…„ (ì´ ${total}ëª…)</span>
                    <div class="flex items-center">
                        <span class="font-bold text-lg text-emerald-600 mr-2">${count}ëª…</span>
                        <span class="text-sm text-gray-500">(${percentage}%)</span>
                    </div>
                `;
                listElement.appendChild(li);

                chartLabels.push(`${grade}í•™ë…„`);
                chartData.push(percentage); // ì°¸ì—¬ìœ¨
            }

            // 2. ë§‰ëŒ€ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
            const ctx = document.getElementById('grade-chart').getContext('2d');
            
            if (chartInstance.current) {
                chartInstance.current.destroy();
            }

            chartInstance.current = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'í•™ë…„ë³„ ì°¸ì—¬ìœ¨ (%)',
                        data: chartData,
                        backgroundColor: [
                            'rgba(16, 185, 129, 0.6)', // 1í•™ë…„
                            'rgba(13, 148, 136, 0.6)', // 2í•™ë…„
                            'rgba(5, 150, 105, 0.6)',  // 3í•™ë…„
                            'rgba(110, 231, 183, 0.6)',// 4í•™ë…„
                            'rgba(107, 114, 128, 0.6)',// 5í•™ë…„
                            'rgba(52, 211, 153, 0.6)'  // 6í•™ë…„
                        ],
                        borderColor: [
                            'rgba(16, 185, 129, 1)',
                            'rgba(13, 148, 136, 1)',
                            'rgba(5, 150, 105, 1)',
                            'rgba(110, 231, 183, 1)',
                            'rgba(107, 114, 128, 1)',
                            'rgba(52, 211, 153, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100, // ìµœëŒ€ê°’ì„ 100ìœ¼ë¡œ ê³ ì •
                            ticks: {
                                callback: function(value) {
                                    return value + '%' // yì¶•ì— % í‘œì‹œ
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // ë²”ë¡€ ìˆ¨ê¸°ê¸°
                        }
                    }
                }
            });
        }

        // 4. ì´ë¦„ ìµëª…í™” (ì˜ˆ: ê¹€OO)
        function anonymizeName(name) {
            if (!name || name.length < 2) return 'O...O';
            
            if (name.length === 2) {
                return `${name[0]}O`; // 2ê¸€ì (ì˜ˆ: í™ê¸¸) -> í™O
            } else {
                const middle = 'O'.repeat(name.length - 2);
                return `${name[0]}${middle}${name[name.length - 1]}`; // 3ê¸€ì ì´ìƒ (ì˜ˆ: í™ê¸¸ë™) -> í™Oë™
            }
        }

        // 5. ìºì‹œë¡œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
        async function fetchDataWithCache() {
            if (allEntriesCache) {
                return allEntriesCache; // (ì´ì „ ìºì‹œê°€ ë‚¨ì•„ìˆì„ ê²½ìš°)
            }
            const data = await fetchData(); // ìºì‹œê°€ ì—†ìœ¼ë©´ GASì—ì„œ ê°€ì ¸ì˜¤ê¸°
            allEntriesCache = data; // ìºì‹œì— ì €ì¥
            return data;
        }

        // 6. í˜ì´ì§€ ì „í™˜ ë° ë„¤ë¹„ê²Œì´ì…˜
        document.addEventListener('DOMContentLoaded', () => {
            const navButtons = document.querySelectorAll('.nav-btn');
            const pages = document.querySelectorAll('.page');
            const chartInstance = { current: null }; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;

                    // 1. ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ë³€ê²½
                    navButtons.forEach(btn => {
                        btn.classList.remove('bg-emerald-500', 'text-white', 'ring-2', 'ring-emerald-600', 'shadow-sm');
                        btn.classList.add('text-emerald-700', 'bg-white', 'hover:bg-gray-100');
                    });
                    button.classList.add('bg-emerald-500', 'text-white', 'ring-2', 'ring-emerald-600', 'shadow-sm');
                    button.classList.remove('text-emerald-700', 'bg-white', 'hover:bg-gray-100');

                    // 2. í˜ì´ì§€ ì „í™˜
                    pages.forEach(page => {
                        if (page.id === `${pageId}-page`) {
                            page.classList.add('active');
                        } else {
                            page.classList.remove('active');
                        }
                    });
                    
                    // 3. í˜ì´ì§€ì— ë§ëŠ” ë°ì´í„° ë¡œë“œ
                    if (pageId === 'gallery') {
                        loadGallery();
                    } else if (pageId === 'dashboard') {
                        if (chartInstance.current) {
                            chartInstance.current.destroy();
                            chartInstance.current = null;
                        }
                        loadDashboard(chartInstance); // ì°¨íŠ¸ ì¸ìŠ¤DìŠ¤ ê°ì²´ë¥¼ ì „ë‹¬
                    }
                });
            });

            // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ (í™ˆ)
            document.getElementById('home-page').classList.add('active');
        });

    </script>
</body>
</html>